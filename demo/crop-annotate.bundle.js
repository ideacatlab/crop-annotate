(function(l,d){typeof exports=="object"&&typeof module<"u"?module.exports=d():typeof define=="function"&&define.amd?define(d):(l=typeof globalThis<"u"?globalThis:l||self,l.CropAnnotate=d())})(this,function(){"use strict";class l{constructor(t){this.editor=t,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.editor.container.appendChild(this.canvas),this.zoomLevel=1,this.minZoom=.1,this.maxZoom=5,this.setupEvents()}setupEvents(){this.canvas.addEventListener("mousedown",t=>this.handleMouseDown(t)),window.addEventListener("mousemove",t=>this.handleMouseMove(t)),window.addEventListener("mouseup",t=>this.handleMouseUp(t)),window.addEventListener("keydown",t=>this.handleKeyDown(t)),this.canvas.addEventListener("wheel",t=>this.handleWheel(t),{passive:!1})}handleWheel(t){if(t.ctrlKey||t.metaKey){t.preventDefault();const e=t.deltaY>0?-.1:.1;this.setZoom(this.zoomLevel+e)}}setZoom(t){const e=Math.max(this.minZoom,Math.min(this.maxZoom,t));e!==this.zoomLevel&&(this.zoomLevel=e,this.updateDisplaySize(),this.editor.onZoomChange&&this.editor.onZoomChange(this.zoomLevel))}getZoom(){return this.zoomLevel}zoomIn(){this.setZoom(this.zoomLevel+.25)}zoomOut(){this.setZoom(this.zoomLevel-.25)}zoomToFit(){const t=this.editor.container.clientWidth||800,e=this.editor.container.clientHeight||600,s=Math.min(t/this.canvas.width,e/this.canvas.height,1);this.setZoom(s)}resetZoom(){this.setZoom(1)}resizeToImage(t){this.canvas.width=t.width,this.canvas.height=t.height,this.zoomToFit()}updateDisplaySize(){const t=Math.floor(this.canvas.width*this.zoomLevel),e=Math.floor(this.canvas.height*this.zoomLevel);this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.canvas.style.display="block"}getMousePos(t){const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height;return{x:(t.clientX-e.left)*s,y:(t.clientY-e.top)*i}}handleMouseDown(t){const e=this.getMousePos(t);this.editor.toolManager.onMouseDown(e,t)}handleMouseMove(t){const e=this.getMousePos(t);this.editor.toolManager.onMouseMove(e,t)}handleMouseUp(t){const e=this.getMousePos(t);this.editor.toolManager.onMouseUp(e,t)}handleKeyDown(t){(t.key==="Delete"||t.key==="Backspace")&&this.editor.state.selectedObject&&!this.editor.state.isEditingText&&(this.editor.state.objects=this.editor.state.objects.filter(e=>e!==this.editor.state.selectedObject),this.editor.state.selectedObject=null,this.editor.saveHistory(),this.render())}render(){const{ctx:t,canvas:e}=this,{image:s,objects:i,activeObject:a,selectedObject:o}=this.editor.state;t.clearRect(0,0,e.width,e.height),s&&t.drawImage(s,0,0,e.width,e.height),i.forEach(n=>{this.drawObject(n),n===o&&this.drawSelection(n)}),a&&this.drawObject(a)}drawObject(t){const{ctx:e}=this;switch(e.save(),e.strokeStyle=t.color,e.lineWidth=t.width,e.fillStyle=t.color,e.font=`${t.fontSize||24}px ${this.editor.options.fontFamily}`,e.lineCap="round",e.lineJoin="round",t.type){case"pencil":t.points&&t.points.length>0&&(e.beginPath(),e.moveTo(t.points[0].x,t.points[0].y),t.points.forEach(s=>e.lineTo(s.x,s.y)),e.stroke());break;case"rect":e.strokeRect(t.x,t.y,t.w,t.h);break;case"circle":e.beginPath(),e.arc(t.x+t.w/2,t.y+t.h/2,Math.abs(t.w/2),0,Math.PI*2),e.stroke();break;case"arrow":this.drawArrow(t.x,t.y,t.x+t.w,t.y+t.h,t.color,t.width);break;case"text":this.drawMultilineText(t);break;case"highlight":e.globalAlpha=.3,e.fillStyle=t.color||"yellow",e.fillRect(t.x,t.y,t.w,t.h);break;case"crop":this.drawCropOverlay(t);break}e.restore()}drawMultilineText(t){const{ctx:e}=this,s=t.text.split(`
`),i=(t.fontSize||24)*1.2;s.forEach((a,o)=>{e.fillText(a,t.x,t.y+o*i)})}getTextBounds(t){const{ctx:e}=this;e.save(),e.font=`${t.fontSize||24}px ${this.editor.options.fontFamily}`;const s=t.text.split(`
`),i=(t.fontSize||24)*1.2;let a=0;s.forEach(n=>{const r=e.measureText(n);a=Math.max(a,r.width)});const o=s.length*i;return e.restore(),{x:t.x,y:t.y-(t.fontSize||24),width:a,height:o}}drawSelection(t){const{ctx:e}=this;e.save(),e.strokeStyle="#007bff",e.lineWidth=1,e.setLineDash([5,5]);let s=5;if(t.type==="pencil"){const i=this.getPencilBounds(t);e.strokeRect(i.x-s,i.y-s,i.w+s*2,i.h+s*2)}else if(t.type==="text"){const i=this.getTextBounds(t);e.strokeRect(i.x-s,i.y-s,i.width+s*2,i.height+s*2)}else{const i=t.w<0?t.x+t.w:t.x,a=t.h<0?t.y+t.h:t.y;e.strokeRect(i-s,a-s,Math.abs(t.w)+s*2,Math.abs(t.h)+s*2)}e.restore()}getPencilBounds(t){let e=1/0,s=1/0,i=-1/0,a=-1/0;return t.points.forEach(o=>{e=Math.min(e,o.x),s=Math.min(s,o.y),i=Math.max(i,o.x),a=Math.max(a,o.y)}),{x:e,y:s,w:i-e,h:a-s}}drawArrow(t,e,s,i,a,o){const{ctx:n}=this,r=15,h=Math.atan2(i-e,s-t);n.beginPath(),n.moveTo(t,e),n.lineTo(s,i),n.stroke(),n.beginPath(),n.moveTo(s,i),n.lineTo(s-r*Math.cos(h-Math.PI/6),i-r*Math.sin(h-Math.PI/6)),n.lineTo(s-r*Math.cos(h+Math.PI/6),i-r*Math.sin(h+Math.PI/6)),n.closePath(),n.fillStyle=a,n.fill()}drawCropOverlay(t){const{ctx:e,canvas:s}=this;e.save();const i=t.w<0?t.x+t.w:t.x,a=t.h<0?t.y+t.h:t.y,o=Math.abs(t.w),n=Math.abs(t.h);e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,0,s.width,a),e.fillRect(0,a+n,s.width,s.height-a-n),e.fillRect(0,a,i,n),e.fillRect(i+o,a,s.width-i-o,n),e.strokeStyle="white",e.lineWidth=2,e.setLineDash([5,5]),e.strokeRect(i,a,o,n),e.strokeStyle="black",e.lineDashOffset=5,e.strokeRect(i,a,o,n),e.restore()}crop(t){const e=t.w<0?t.x+t.w:t.x,s=t.h<0?t.y+t.h:t.y,i=Math.abs(t.w),a=Math.abs(t.h);if(i<10||a<10)return;const o=document.createElement("canvas");o.width=i,o.height=a,o.getContext("2d").drawImage(this.canvas,e,s,i,a,0,0,i,a);const r=new Image;r.onload=()=>{this.editor.state.image=r,this.editor.state.objects=[],this.canvas.width=i,this.canvas.height=a,this.zoomToFit(),this.editor.saveHistory(),this.render()},r.src=o.toDataURL()}flip(t){const e=document.createElement("canvas");e.width=this.canvas.width,e.height=this.canvas.height;const s=e.getContext("2d");s.save(),t==="horizontal"?(s.scale(-1,1),s.drawImage(this.canvas,-this.canvas.width,0)):(s.scale(1,-1),s.drawImage(this.canvas,0,-this.canvas.height)),s.restore();const i=new Image;i.onload=()=>{this.editor.state.image=i,this.editor.state.objects=[],this.editor.saveHistory(),this.render()},i.src=e.toDataURL()}rotate(t){const e=document.createElement("canvas");e.width=this.canvas.height,e.height=this.canvas.width;const s=e.getContext("2d");s.save(),t==="right"?(s.translate(e.width,0),s.rotate(Math.PI/2)):(s.translate(0,e.height),s.rotate(-Math.PI/2)),s.drawImage(this.canvas,0,0),s.restore();const i=this.zoomLevel,a=new Image;a.onload=()=>{this.editor.state.image=a,this.editor.state.objects=[],this.canvas.width=e.width,this.canvas.height=e.height,this.setZoom(i),this.editor.saveHistory(),this.render()},a.src=e.toDataURL()}restoreState(t){return new Promise(e=>{if(t.imageSrc){const s=new Image;s.onload=()=>{this.editor.state.image=s,this.canvas.width=t.canvasWidth,this.canvas.height=t.canvasHeight,this.zoomToFit(),this.render(),e()},s.onerror=()=>{this.canvas.width=t.canvasWidth,this.canvas.height=t.canvasHeight,this.zoomToFit(),this.render(),e()},s.src=t.imageSrc}else this.canvas.width=t.canvasWidth,this.canvas.height=t.canvasHeight,this.zoomToFit(),this.render(),e()})}}class d{constructor(t){this.editor=t,this.startPos=null,this.dragOffset=null,this.isDragging=!1}onMouseDown(t,e){const{currentTool:s,objects:i}=this.editor.state;if(s==="select"){const a=this.findObjectAt(t);this.editor.state.selectedObject=a,a&&(this.isDragging=!0,this.dragOffset={x:t.x-a.x,y:t.y-a.y},a.type==="pencil"&&(this.dragOffset.points=a.points.map(o=>({x:t.x-o.x,y:t.y-o.y}))),a.type==="text"&&e.detail===2&&this.startInlineTextEdit(a)),this.editor.canvasManager.render();return}if(this.editor.state.isDrawing=!0,this.startPos=t,s==="text"){this.createNewText(t);return}this.editor.state.activeObject={type:s,x:t.x,y:t.y,w:0,h:0,color:this.editor.state.currentColor,width:this.editor.state.currentWidth,points:s==="pencil"?[{x:t.x,y:t.y}]:[]}}onMouseMove(t){const{isDrawing:e,activeObject:s,selectedObject:i,currentTool:a}=this.editor.state;if(a==="select"&&this.isDragging&&i){if(i.type==="pencil"){i.points=this.dragOffset.points.map(n=>({x:t.x-n.x,y:t.y-n.y}));const o=this.editor.canvasManager.getPencilBounds(i);i.x=o.x,i.y=o.y}else i.x=t.x-this.dragOffset.x,i.y=t.y-this.dragOffset.y;this.editor.canvasManager.render();return}if(!(!e||!s)){if(s.type==="pencil")s.points.push({x:t.x,y:t.y});else if(s.type==="crop"&&this.editor.state.cropAspectRatio){const o=this.editor.state.cropAspectRatio,n=o.width/o.height;let r=t.x-this.startPos.x,h=t.y-this.startPos.y;const c=Math.abs(r),x=Math.abs(h);c/n>x?h=c/n*Math.sign(h||1):r=x*n*Math.sign(r||1),s.w=r,s.h=h}else s.w=t.x-this.startPos.x,s.h=t.y-this.startPos.y;this.editor.canvasManager.render()}}onMouseUp(t){const{isDrawing:e,activeObject:s,currentTool:i}=this.editor.state;if(i==="select"){this.isDragging&&(this.editor.saveHistory(),this.isDragging=!1);return}e&&(s&&(s.type==="crop"?this.editor.canvasManager.crop(s):this.isValidObject(s)&&(this.editor.state.objects.push(s),this.editor.saveHistory())),this.editor.state.isDrawing=!1,this.editor.state.activeObject=null,this.editor.canvasManager.render())}isValidObject(t){return t.type==="pencil"?t.points.length>1:t.type==="text"?t.text.length>0:Math.abs(t.w)>2||Math.abs(t.h)>2}findObjectAt(t){const e=[...this.editor.state.objects].reverse();for(const s of e)if(this.isPointInObject(t,s))return s;return null}isPointInObject(t,e){if(e.type==="pencil")return e.points.some(r=>Math.hypot(r.x-t.x,r.y-t.y)<10);if(e.type==="text"){const r=this.editor.canvasManager.getTextBounds(e);return t.x>=r.x-10&&t.x<=r.x+r.width+10&&t.y>=r.y-10&&t.y<=r.y+r.height+10}const i=e.w<0?e.x+e.w:e.x,a=e.h<0?e.y+e.h:e.y,o=Math.abs(e.w),n=Math.abs(e.h);return e.type==="arrow"?this.distToSegment(t,{x:e.x,y:e.y},{x:e.x+e.w,y:e.y+e.h})<10:t.x>=i-10&&t.x<=i+o+10&&t.y>=a-10&&t.y<=a+n+10}distToSegment(t,e,s){const i=Math.pow(e.x-s.x,2)+Math.pow(e.y-s.y,2);if(i===0)return Math.hypot(t.x-e.x,t.y-e.y);let a=((t.x-e.x)*(s.x-e.x)+(t.y-e.y)*(s.y-e.y))/i;return a=Math.max(0,Math.min(1,a)),Math.hypot(t.x-(e.x+a*(s.x-e.x)),t.y-(e.y+a*(s.y-e.y)))}createNewText(t){const e=document.createElement("textarea");e.style.position="fixed",e.style.resize="none",e.style.overflow="hidden";const s=this.editor.canvasManager.canvas.getBoundingClientRect(),i=s.width/this.editor.canvasManager.canvas.width,a=this.editor.options.fontSize*i;e.style.left=s.left+t.x*i+"px",e.style.top=s.top+t.y*i-a+"px",e.style.font=`${a}px ${this.editor.options.fontFamily}`,e.style.color=this.editor.state.currentColor,e.style.border="1px dashed #007bff",e.style.background="rgba(255,255,255,0.8)",e.style.outline="none",e.style.padding="2px",e.style.margin="0",e.style.zIndex="10000",e.style.minWidth="100px",e.style.minHeight=a+"px",e.style.lineHeight="1.2",e.rows=1,document.body.appendChild(e),setTimeout(()=>e.focus(),10);const o=()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px"};e.addEventListener("input",o);let n=!1;const r=()=>{n||(n=!0,e.value.trim()&&(this.editor.state.objects.push({type:"text",x:t.x,y:t.y,text:e.value,color:this.editor.state.currentColor,fontSize:this.editor.options.fontSize}),this.editor.saveHistory(),this.editor.canvasManager.render()),e.parentNode&&document.body.removeChild(e),this.editor.state.isDrawing=!1)};e.onblur=r,e.onkeydown=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),r()),h.key==="Escape"&&(n=!0,document.body.removeChild(e),this.editor.state.isDrawing=!1)}}startInlineTextEdit(t){const e=document.createElement("textarea");e.value=t.text,e.style.position="fixed",e.style.resize="none",e.style.overflow="hidden";const s=this.editor.canvasManager.canvas.getBoundingClientRect(),i=s.width/this.editor.canvasManager.canvas.width,a=t.fontSize*i;e.style.left=s.left+t.x*i+"px",e.style.top=s.top+t.y*i-a+"px",e.style.font=`${a}px ${this.editor.options.fontFamily}`,e.style.color=t.color,e.style.border="1px dashed #007bff",e.style.background="rgba(255,255,255,0.8)",e.style.outline="none",e.style.padding="2px",e.style.zIndex="10000",e.style.minWidth="100px",e.style.lineHeight="1.2",document.body.appendChild(e);const o=()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px"};e.addEventListener("input",o),setTimeout(()=>{e.focus(),e.select(),o()},10),this.editor.state.isEditingText=!0;const n=t.text;t.text="",this.editor.canvasManager.render();let r=!1;const h=()=>{r||(r=!0,t.text=e.value.trim()||n,e.value!==n&&this.editor.saveHistory(),e.parentNode&&document.body.removeChild(e),this.editor.state.isEditingText=!1,this.editor.canvasManager.render())};e.onblur=h,e.onkeydown=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),h()),c.key==="Escape"&&(r=!0,t.text=n,document.body.removeChild(e),this.editor.state.isEditingText=!1,this.editor.canvasManager.render())}}}class g{constructor(t,e={}){this.container=typeof t=="string"?document.querySelector(t):t,this.options={strokeColor:e.strokeColor||"#ff0000",strokeWidth:e.strokeWidth||3,fontSize:e.fontSize||24,fontFamily:e.fontFamily||"Arial",...e},this.state={image:null,currentTool:"select",currentColor:this.options.strokeColor,currentWidth:this.options.strokeWidth,objects:[],history:[],historyIndex:-1,activeObject:null,isDrawing:!1,selectedObject:null,cropAspectRatio:null},this.translations={},this.onZoomChange=null,this.init()}init(){this.canvasManager=new l(this),this.toolManager=new d(this),this.container.style.position="relative",this.container.style.userSelect="none",this.container.style.outline="none"}async loadImage(t){return new Promise((e,s)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{this.state.image=i,this.state.objects=[],this.state.history=[],this.state.historyIndex=-1,this.canvasManager.resizeToImage(i),this.saveHistory(),this.canvasManager.render(),e(i)},i.onerror=a=>{console.error("Image load error:",a),s(a)},i.src=t})}setTool(t){this.state.currentTool=t,this.state.selectedObject=null,this.canvasManager.render()}setColor(t){this.state.currentColor=t,this.state.selectedObject&&(this.state.selectedObject.color=t,this.saveHistory(),this.canvasManager.render())}setCropAspectRatio(t){if(t===null||t==="free")this.state.cropAspectRatio=null;else if(t==="square"||t==="1:1")this.state.cropAspectRatio={width:1,height:1};else if(typeof t=="string"){const e=t.split(":");e.length===2&&(this.state.cropAspectRatio={width:parseFloat(e[0]),height:parseFloat(e[1])})}else t&&typeof t=="object"&&t.width&&t.height&&(this.state.cropAspectRatio=t)}getCropAspectRatio(){return this.state.cropAspectRatio}setZoom(t){this.canvasManager.setZoom(t)}getZoom(){return this.canvasManager.getZoom()}zoomIn(){this.canvasManager.zoomIn()}zoomOut(){this.canvasManager.zoomOut()}zoomToFit(){this.canvasManager.zoomToFit()}resetZoom(){this.canvasManager.resetZoom()}saveHistory(){const t={objects:JSON.parse(JSON.stringify(this.state.objects)),imageSrc:this.state.image?this.state.image.src:null,canvasWidth:this.canvasManager.canvas.width,canvasHeight:this.canvasManager.canvas.height};this.state.history=this.state.history.slice(0,this.state.historyIndex+1),this.state.history.push(t),this.state.historyIndex++}undo(){this.state.historyIndex>0&&(this.state.historyIndex--,this.restoreFromHistory())}redo(){this.state.historyIndex<this.state.history.length-1&&(this.state.historyIndex++,this.restoreFromHistory())}canUndo(){return this.state.historyIndex>0}canRedo(){return this.state.historyIndex<this.state.history.length-1}restoreFromHistory(){const t=this.state.history[this.state.historyIndex];this.state.objects=JSON.parse(JSON.stringify(t.objects)),this.state.selectedObject=null,this.canvasManager.restoreState(t)}flip(t){this.canvasManager.flip(t)}rotate(t){this.canvasManager.rotate(t)}export(t="image/png",e=.92){return this.canvasManager.canvas.toDataURL(t,e)}getImageSize(){return{width:this.canvasManager.canvas.width,height:this.canvasManager.canvas.height}}getTextAnnotations(){let t=0;return this.state.objects.filter(e=>e.type==="text").map(e=>(e._textId||(e._textId=`text_${t++}_${Math.round(e.x)}_${Math.round(e.y)}`),{id:e._textId,text:e.text,x:e.x,y:e.y,color:e.color,fontSize:e.fontSize}))}setTranslations(t,e){this.translations[t]={...e}}getTranslations(t){return this.translations[t]||null}getAvailableTranslations(){return Object.keys(this.translations)}clearTranslations(t){t?delete this.translations[t]:this.translations={}}exportWithTranslations(t,e="image/png",s=.92){const i=this.translations[t];if(!i)return null;const a=new Map;this.state.objects.forEach(n=>{n.type==="text"&&n._textId&&i[n._textId]&&(a.set(n,n.text),n.text=i[n._textId])}),this.canvasManager.render();const o=this.canvasManager.canvas.toDataURL(e,s);return a.forEach((n,r)=>{r.text=n}),this.canvasManager.render(),o}exportAllVersions(t="image/png",e=.92){const s={original:this.export(t,e)};return Object.keys(this.translations).forEach(i=>{const a=this.exportWithTranslations(i,t,e);a&&(s[i]=a)}),s}destroy(){this.canvasManager&&this.canvasManager.canvas&&this.canvasManager.canvas.remove()}}return typeof window<"u"&&(window.CropAnnotate=g),g});
//# sourceMappingURL=crop-annotate.min.js.map
